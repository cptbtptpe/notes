  
## 三步握手 和 四次挥手  
  
### 三步握手  
  
  
第一次握手：建立连接时，客户端发送syn包（syn=j）到服务器，并进入SYN_SENT状态，等待服务器确认；SYN：同步序列编号（Synchronize Sequence Numbers）。  
  
第二次握手：服务器收到syn包，必须确认客户的SYN（ack=j+1），同时自己也发送一个SYN包（syn=k），即SYN+ACK包，此时服务器进入SYN_RECV状态；  
第三次  
  
第三次握手：客户端收到服务器的SYN+ACK包，向服务器发送确认包ACK(ack=k+1），此包发送完毕，客户端和服务器进入ESTABLISHED（TCP连接成功）状态，完成三次握手。  
  
---  
  
### 改进的三次握手  
  
对于一个已经建立的连接，TCP使用改进的三次握手来释放连接（使用一个带有FIN附加标记的报文段）。TCP关闭连接的步骤如下：  
  
第一步，当主机A的应用程序通知TCP数据已经发送完毕时，TCP向主机B发送一个带有FIN附加标记的报文段（FIN表示英文finish）。  
  
第二步，主机B收到这个FIN报文段之后，并不立即用FIN报文段回复主机A，而是先向主机A发送一个确认序号ACK，同时通知自己相应的应用程序：对方要求关闭连接（先发送ACK的目的是为了防止在这段时间内，对方重传FIN报文段）。  
  
第三步，主机B的应用程序告诉TCP：我要彻底的关闭连接，TCP向主机A送一个FIN报文段。  
  
第四步，主机A收到这个FIN报文段后，向主机B发送一个ACK表示连接彻底释放。  
  
---  
  
- [x] 认识TCP标志位 - 6种  
  
    `SYN(synchronous建立联机)`  
    `ACK(acknowledgement 确认)`  
    `PSH(push传送)`  
    `FIN(finish结束)`  
    `RST(reset重置)`  
    `URG(urgent紧急)`  
  
---  
  
### 三次握手过程  
  
第一次握手：host1发送一个TCP标志位SYN=1、ACK=0的数据包给host2，并随机会产生一个Sequence number=3233.当host2接收到这个数据后，host2由SYN=1可知客户端是想要建立连接；  
  
第二次握手：host2要对客户端的联机请求进行确认，向host1发送应答号ACK=1、SYN=1、确认号Acknowledge number=3234，此值是host1的序列号加1，还会产生一个随机的序列号Sequence number=36457，这样就告诉host1可以进行连接；  
  
第三次握手：host1收到数据后检查Acknowledge number是否是3233+1的值，以及ACK的值是否为1，若为1，host1会发送ACK=1、确认号码Acknowledge number=36457，告诉host2,你的请求连接被确认，连接可以建立。  
  
---  
  
### 四次挥手过程：  
  
第一次挥手：当传输的数据到达尾部时，host1向host2发送FIN=1标志位；可理解成，host1向host2说，我这边的数据传送完成了，我准备断开了连接；  
  
第二次挥手：因TCP的连接是全双工的双向连接，关闭也是要从两边关闭；当host2收到host1发来的FIN=1的标志位后，host2不会立刻向host1发送FIND=1的请求关闭信息，而是先向host1发送一个ACK=1的应答信息，表示：你请求关闭的请求我已经收到，但我可能还有数据没有完成传送，你再等下，等我数据传输完成了我就告诉你；  
  
第三次挥手：host2数据传输完成，向host1发送FIN=1，host1收到请求关闭连接的请求后，host1就明白host2的数据已传输完成，现在可以断开连接了，  
  
第四次挥手：host1收到FIND=1后，host1还是怕由于网络不稳定的原因，怕host2不知道他要断开连接，于是向host2发送ACK=1确认信息进行确认，把自己设置成TIME_WAIT状态并启动定时器，如果host2没有收到ACK，host2端TCP的定时器到达后，会要求host1重新发送ACK，当host2收到ACK后，host2就断开连接；当host1等待2MLS（2倍报文最大生存时间）后，没有收到host2的重传请求后，他就知道host2已收到了ACK，所以host1此时才关闭自己的连接。这一点我觉得设计得非常巧妙！  
  
---  
  
### 图解TCP与UDP的三次握手与四次挥手过程  
![图解TCP与UDP的三次握手与四次挥手过程][1]  
  
  
  [1]: http://image76.360doc.com/DownloadImg/2014/07/2520/43725155_1.png  
